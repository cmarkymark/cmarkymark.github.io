---
title: "K-Cross Validation Random Trees"
author: "Charles Marks"
date: "December 8, 2018"
output: html_document
---

```{r global options}
library(tidyverse)
library(tableone)
library(PerformanceAnalytics)
library(psych)
library(ROCR)
library(randomForest)
options(digits = 2)
knitr::opts_chunk$set(warning=FALSE, message=FALSE)
```

## Analytic Plan

We shall conduct a series of multivariate logisitic regression in order to determine factors related to needing glaucoma surgery.  First, we shall split our variables up into 3 categories : 1) vital statistics and hosptalizations, 2) diagnoses, and 3) prescribed medications.  We shall conduct a multivariate regression for each of these variable categories, and finally run a final model combining variables.

## Uploading and Cleaning the Final Dataset

### Loading the Data

```{r dataset}

#df <- read.csv("Dec8_Dataset.csv", header=TRUE)

```

### Exclusion Criteria

So, now we need to exclude people based on certain factors.  There are two primary exclusion criteria, the first being that patients must have been in care in the UC system prior to their surgery (ie we dont want people who just came to UC for surgery, as they will skew the results towards non-significance)

```{r pressure, echo=FALSE}

#clean_data <- data.frame(matrix(nrow=0,ncol=ncol(df)))
#colnames(clean_data) <- colnames(df)

#surgery_exclude_data <- data.frame(matrix(nrow=0,ncol=ncol(df)))
#colnames(surgery_exclude_data) <- colnames(df)

#newpatient_exclude_data <- data.frame(matrix(nrow=0,ncol=ncol(df)))
#colnames(newpatient_exclude_data) <- colnames(df)

#no_vital_data_exclude_data <- data.frame(matrix(nrow=0,ncol=ncol(df)))
#colnames(no_vital_data_exclude_data) <- colnames(df)

#for(patient_num in 1:nrow(df))
#{ 
#  if(!is.na(df$first_surgery_date[patient_num]) && !is.na(df$first_vitals_contact_date[patient_num]))
#  {
#    time_test <- difftime(df$first_surgery_date[patient_num], df$first_vitals_contact_date[patient_num], units = "days")
#    if(time_test > 180)
#    {
      
#      clean_data <- rbind(clean_data, df[patient_num,])
#    } else {surgery_exclude_data <- rbind(surgery_exclude_data, df[patient_num,])}
#  } 
#  else if(is.na(df$first_surgery_date[patient_num]) && !is.na(df$first_vitals_contact_date[patient_num]))
#  {
#    time_test2 <- difftime(as.Date("11/01/2018","%m/%d/%Y"), df$first_vitals_contact_date[patient_num], units = "days")
#    if(time_test2 > 180)
#    {
#     clean_data <- rbind(clean_data, df[patient_num,])
#    } else {
#      newpatient_exclude_data <- rbind(newpatient_exclude_data, df[patient_num,])
#    }
#  } else
#  {
#    no_vital_data_exclude_data <- rbind(no_vital_data_exclude_data, df[patient_num,])
#  }
#}



```

### After Exlcusions

We need to decide if we want the exclusion to be 1 year or 6 months

### Imputing Missing Data

```{r impute}


## systolic_sd 30 NA

#clean_data$systolic_sd[is.na(clean_data$systolic_sd)] <- mean(clean_data$systolic_sd, na.rm = TRUE)

## diastolic_sd 30 NA

#clean_data$diastolic_sd[is.na(clean_data$diastolic_sd)] <- mean(clean_data$diastolic_sd, na.rm = TRUE)

## BMI mean 4 NA

#clean_data$BMI_mean[is.na(clean_data$BMI_mean)] <- median(clean_data$BMI_mean, na.rm = TRUE)
# attempts at imputing messed up analyses for some reason

## BMI max 3 NA (median)
#clean_data$BMI_max[is.na(clean_data$BMI_max)] <- median(clean_data$BMI_max, na.rm = TRUE)

## BMImin 3 NA (median)
#clean_data$BMI_min[is.na(clean_data$BMI_min)] <- median(clean_data$BMI_min, na.rm = TRUE)

## alcohol use (12 NAs)
## we will not imput given categorical nature, unclear how this will skew the results
## if it is not significant in initial analyses we will simply exclude from final analyses 

## smoking status (1 NA)
```

## Table One

Here is the descriptive statistics, stratified by history of glaucoma surgery.  Rows from this can be taken to present a final descriptive table, if so desired.  Descriptive table might not be overly meaningful tho...

```{r tableone}



tone_vars = colnames(clean_data)
tone_vars[12] <- NA
tone_vars[28] <- NA

tone <- tableone::CreateTableOne(vars = tone_vars, strata = c("any_glaucoma_surgey") ,data =  clean_data)

```
```{r Bivariate, warning=FALSE}
bi.final <- data.frame(matrix(nrow = 0, ncol = 3))
for(i in 3:ncol(clean_data))
{
if(i == 11 || i == 12 || i == 22 || i == 23 || i == 24 || i == 25 || i == 26 ||i == 28 || i == 135 || i == 130 || i == 123 || i == 109 || i == 104 || i == 92 || i == 84 ||  i == 78 || i == 54 || i == 53){}
  else{
iv <- colnames(clean_data)[i] 
bi.model <- glm (any_glaucoma_surgey ~ get(iv), data = clean_data, family = binomial(link="logit"))
#summary(age)
bi.results <- exp(cbind(OR = coef(bi.model), confint(bi.model)))
rownames(bi.results)[2] <- colnames(clean_data)[i]
bi.final <- rbind(bi.final, bi.results)
}
}



bi.signif <- bi.final[which(bi.final$`2.5 %` > 1 | bi.final$`97.5 %`<1),]
```


## Creating the five groups for cross-validation

```{r fivegroups}

values <- rep(1:5, length.out=391)
random <- sample(values)
clean_data$cv_group <- random

```

## Defining Our Five Groups

```{r define groups}

train.one <- clean_data[which(clean_data$cv_group!= 1),]
test.one <- clean_data[which(clean_data$cv_group== 1),]

train.two <- clean_data[which(clean_data$cv_group!= 2),]
test.two <- clean_data[which(clean_data$cv_group== 2),]

train.three <- clean_data[which(clean_data$cv_group!= 3),]
test.three <- clean_data[which(clean_data$cv_group== 3),]

train.four <- clean_data[which(clean_data$cv_group!= 4),]
test.four <- clean_data[which(clean_data$cv_group== 4),]

train.five <- clean_data[which(clean_data$cv_group!= 5),]
test.five <- clean_data[which(clean_data$cv_group== 5),]

```

## Running Cross Val

### Test 1

```{r test 1, include=FALSE}



model.rf.one = randomForest(any_glaucoma_surgey ~ Age + Gender +systolic_max + systolic_min + systolic_mean  + diastolic_max + diastolic_min + diastolic_mean +pulse_min + pulse_max + pulse_mean  +ever_hospitalized + days_hospitalized + CHF + PVD + Stroke + Dementia + Pulmonary + LiverMild + DM + DMcx  + Renal + Cancer + Mets + med_class.Analgesics_._non.opioids + med_class.Analgesics_._opioids  +  med_class.Anti.rheumatic +  med_class.Antianxiety_agents  + med_class.Antiasthmatic + med_class.Anticoagulants+med_class.Anticonvulsant+med_class.Antidepressants+med_class.Antidiabetic+med_class.Antiemetics+med_class.Antihyperlipidemic+med_class.Antihypertensive+med_class.Beta_blockers+med_class.Calcium_blockers+med_class.Corticosteroids+med_class.Cough.Cold+med_class.Decongestants+med_class.Dermatological+med_class.Diuretics+med_class.Laxatives+med_class.Macrolide_antibiotics+med_class.Misc._antiinfectives+med_class.Ophthalmic+med_class.Ulcer_drugs, 
                 data=train.one, importance = TRUE, mtry = 6
                 )

rf.one.pr <- predict(model.rf.one, test.one, type="prob")[,2]
rf.one.pred <- prediction(rf.one.pr,test.one$any_glaucoma_surgey)
rf.one.perf <- performance(rf.one.pred,"tpr","fpr")

plot(rf.one.perf,main="ROC Curve for Random Forest",col=2,lwd=2)
abline(a=0,b=1,lwd=2,lty=2,col="gray")

rf.one.auc <- performance(rf.one.pred,"auc")@y.values[[1]]

```


```{r get sensitivity and specificity}
opt.cut = function(perf, pred){
    cut.ind = mapply(FUN=function(x, y, p){
        d = (x - 0)^2 + (y-1)^2
        ind = which(d == min(d))
        c(sensitivity = y[[ind]], specificity = 1-x[[ind]], 
            cutoff = p[[ind]])
    }, perf@x.values, perf@y.values, pred@cutoffs)
}
print(opt.cut(rf.one.perf, rf.one.pred))


acc.perf = performance(rf.one.pred, measure = "acc")
plot(acc.perf)

ind = which.max( slot(acc.perf, "y.values")[[1]] )
acc = slot(acc.perf, "y.values")[[1]][ind]
cutoff = slot(acc.perf, "x.values")[[1]][ind]
print(c(accuracy= acc, cutoff = cutoff))

```

### Test 2

```{r test 2, include=FALSE}



model.rf.two = randomForest(any_glaucoma_surgey ~ Age + Gender +systolic_max + systolic_min + systolic_mean  + diastolic_max + diastolic_min + diastolic_mean +pulse_min + pulse_max + pulse_mean  +ever_hospitalized + days_hospitalized  +CHF + PVD + Stroke + Dementia + Pulmonary + LiverMild + DM + DMcx  + Renal + Cancer + Mets + med_class.Analgesics_._non.opioids + med_class.Analgesics_._opioids  +  med_class.Anti.rheumatic +  med_class.Antianxiety_agents  + med_class.Antiasthmatic + med_class.Anticoagulants+med_class.Anticonvulsant+med_class.Antidepressants+med_class.Antidiabetic+med_class.Antiemetics+med_class.Antihyperlipidemic+med_class.Antihypertensive+med_class.Beta_blockers+med_class.Calcium_blockers+med_class.Corticosteroids+med_class.Cough.Cold+med_class.Decongestants+med_class.Dermatological+med_class.Diuretics+med_class.Laxatives+med_class.Macrolide_antibiotics+med_class.Misc._antiinfectives+med_class.Ophthalmic+med_class.Ulcer_drugs, 
                 data=train.two, importance = TRUE, mtry = 6
                 )

rf.two.pr <- predict(model.rf.two, test.two, type="prob")[,2]
rf.two.pred <- prediction(rf.two.pr,test.two$any_glaucoma_surgey)
rf.two.perf <- performance(rf.two.pred,"tpr","fpr")

plot(rf.two.perf,main="ROC Curve for Random Forest",col=2,lwd=2)
abline(a=0,b=1,lwd=2,lty=2,col="gray")

rf.two.auc <- performance(rf.two.pred,"auc")@y.values[[1]]

```

### Test 3

```{r test 3, include=FALSE}



model.rf.three = randomForest(any_glaucoma_surgey ~ Age + Gender +systolic_max + systolic_min + systolic_mean  + diastolic_max + diastolic_min + diastolic_mean +pulse_min + pulse_max + pulse_mean  +ever_hospitalized + days_hospitalized  +CHF + PVD + Stroke + Dementia + Pulmonary + LiverMild + DM + DMcx  + Renal + Cancer + Mets + med_class.Analgesics_._non.opioids + med_class.Analgesics_._opioids  +  med_class.Anti.rheumatic +  med_class.Antianxiety_agents  + med_class.Antiasthmatic + med_class.Anticoagulants+med_class.Anticonvulsant+med_class.Antidepressants+med_class.Antidiabetic+med_class.Antiemetics+med_class.Antihyperlipidemic+med_class.Antihypertensive+med_class.Beta_blockers+med_class.Calcium_blockers+med_class.Corticosteroids+med_class.Cough.Cold+med_class.Decongestants+med_class.Dermatological+med_class.Diuretics+med_class.Laxatives+med_class.Macrolide_antibiotics+med_class.Misc._antiinfectives+med_class.Ophthalmic+med_class.Ulcer_drugs, 
                 data=train.three, importance = TRUE, mtry = 6
                 )

rf.three.pr <- predict(model.rf.three, test.three, type="prob")[,2]
rf.three.pred <- prediction(rf.three.pr,test.three$any_glaucoma_surgey)
rf.three.perf <- performance(rf.three.pred,"tpr","fpr")

plot(rf.three.perf,main="ROC Curve for Random Forest",col=2,lwd=2)
abline(a=0,b=1,lwd=2,lty=2,col="gray")

rf.three.auc <- performance(rf.three.pred,"auc")@y.values[[1]]

```
### Test 4

```{r test 4, include=FALSE}



model.rf.four = randomForest(any_glaucoma_surgey ~ Age + Gender +systolic_max + systolic_min + systolic_mean  + diastolic_max + diastolic_min + diastolic_mean +pulse_min + pulse_max + pulse_mean  +ever_hospitalized + days_hospitalized  +CHF + PVD + Stroke + Dementia + Pulmonary + LiverMild + DM + DMcx  + Renal + Cancer + Mets + med_class.Analgesics_._non.opioids + med_class.Analgesics_._opioids  +  med_class.Anti.rheumatic +  med_class.Antianxiety_agents  + med_class.Antiasthmatic + med_class.Anticoagulants+med_class.Anticonvulsant+med_class.Antidepressants+med_class.Antidiabetic+med_class.Antiemetics+med_class.Antihyperlipidemic+med_class.Antihypertensive+med_class.Beta_blockers+med_class.Calcium_blockers+med_class.Corticosteroids+med_class.Cough.Cold+med_class.Decongestants+med_class.Dermatological+med_class.Diuretics+med_class.Laxatives+med_class.Macrolide_antibiotics+med_class.Misc._antiinfectives+med_class.Ophthalmic+med_class.Ulcer_drugs, 
                 data=train.four, importance = TRUE, mtry = 6
                 )

rf.four.pr <- predict(model.rf.four, test.four, type="prob")[,2]
rf.four.pred <- prediction(rf.four.pr,test.four$any_glaucoma_surgey)
rf.four.perf <- performance(rf.four.pred,"tpr","fpr")

plot(rf.four.perf,main="ROC Curve for Random Forest",col=2,lwd=2)
abline(a=0,b=1,lwd=2,lty=2,col="gray")

rf.four.auc <- performance(rf.four.pred,"auc")@y.values[[1]]

```
### Test 5

```{r test 5, include=FALSE}



model.rf.five = randomForest(any_glaucoma_surgey ~ Age + Gender +systolic_max + systolic_min + systolic_mean  + diastolic_max + diastolic_min + diastolic_mean +pulse_min + pulse_max + pulse_mean  +ever_hospitalized + days_hospitalized  +CHF + PVD + Stroke + Dementia + Pulmonary + LiverMild + DM + DMcx  + Renal + Cancer + Mets + med_class.Analgesics_._non.opioids + med_class.Analgesics_._opioids  +  med_class.Anti.rheumatic +  med_class.Antianxiety_agents  + med_class.Antiasthmatic + med_class.Anticoagulants+med_class.Anticonvulsant+med_class.Antidepressants+med_class.Antidiabetic+med_class.Antiemetics+med_class.Antihyperlipidemic+med_class.Antihypertensive+med_class.Beta_blockers+med_class.Calcium_blockers+med_class.Corticosteroids+med_class.Cough.Cold+med_class.Decongestants+med_class.Dermatological+med_class.Diuretics+med_class.Laxatives+med_class.Macrolide_antibiotics+med_class.Misc._antiinfectives+med_class.Ophthalmic+med_class.Ulcer_drugs, 
                 data=train.five, importance = TRUE, mtry = 6
                 )

rf.five.pr <- predict(model.rf.five, test.five, type="prob")[,2]
rf.five.pred <- prediction(rf.five.pr,test.five$any_glaucoma_surgey)
rf.five.perf <- performance(rf.five.pred,"tpr","fpr")

plot(rf.five.perf,main="ROC Curve for Random Forest",col=2,lwd=2)
abline(a=0,b=1,lwd=2,lty=2,col="gray")

rf.five.auc <- performance(rf.five.pred,"auc")@y.values[[1]]

```
### COMAPRE ROC

```{r roc comapre}

print(rf.one.auc)
print(rf.two.auc)
print(rf.three.auc)
print(rf.four.auc)
print(rf.five.auc)

```

## Results of Best Model

```{r looking at the best}

results <- importance(model.rf.two)
results

```

## Evaluating This Model

### Discrimination (C-Statistic aka AUC)

```{r AUC}

plot(rf.two.perf,main="ROC Curve for Random Forest",col=2,lwd=2)
abline(a=0,b=1,lwd=2,lty=2,col="gray")


```

### Caibration (Hoslem-Lemeshow)

```{r calibration}


library(gbm)
calibrate.plot(test.two$any_glaucoma_surgey, rf.two.pr)
```


```{r Saving Docs}

final_test_set <- test.two
final_training_set <- train.two

importance_scores <- importance(model.rf.two)

write.csv(final_test_set, "Final_Test_Set_RandomForests_Dec10.csv")
write.csv(final_training_set, "Final_Training_Set_RandomForests_Dec8.csv")
write.csv(importance_scores, "Final_Importance_Scores_random_Forest.csv")

```
