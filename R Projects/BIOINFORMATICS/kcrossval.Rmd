---
title: "K-Cross Validation"
author: "Charles Marks"
date: "December 8, 2018"
output: html_document
---

```{r global options}
library(tidyverse)
library(tableone)
library(PerformanceAnalytics)
library(psych)
options(digits = 2)
knitr::opts_chunk$set(warning=FALSE, message=FALSE)
```

## Analytic Plan

We shall conduct a series of multivariate logisitic regression in order to determine factors related to needing glaucoma surgery.  First, we shall split our variables up into 3 categories : 1) vital statistics and hosptalizations, 2) diagnoses, and 3) prescribed medications.  We shall conduct a multivariate regression for each of these variable categories, and finally run a final model combining variables.

## Uploading and Cleaning the Final Dataset

### Loading the Data

```{r dataset}

df <- read.csv("Dec8_Dataset.csv", header=TRUE)

```

### Exclusion Criteria

So, now we need to exclude people based on certain factors.  There are two primary exclusion criteria, the first being that patients must have been in care in the UC system prior to their surgery (ie we dont want people who just came to UC for surgery, as they will skew the results towards non-significance)

```{r pressure, echo=FALSE}

clean_data <- data.frame(matrix(nrow=0,ncol=ncol(df)))
colnames(clean_data) <- colnames(df)

surgery_exclude_data <- data.frame(matrix(nrow=0,ncol=ncol(df)))
colnames(surgery_exclude_data) <- colnames(df)

newpatient_exclude_data <- data.frame(matrix(nrow=0,ncol=ncol(df)))
colnames(newpatient_exclude_data) <- colnames(df)

no_vital_data_exclude_data <- data.frame(matrix(nrow=0,ncol=ncol(df)))
colnames(no_vital_data_exclude_data) <- colnames(df)

for(patient_num in 1:nrow(df))
{ 
  if(!is.na(df$first_surgery_date[patient_num]) && !is.na(df$first_vitals_contact_date[patient_num]))
  {
    time_test <- difftime(df$first_surgery_date[patient_num], df$first_vitals_contact_date[patient_num], units = "days")
    if(time_test > 180)
    {
      
      clean_data <- rbind(clean_data, df[patient_num,])
    } else {surgery_exclude_data <- rbind(surgery_exclude_data, df[patient_num,])}
  } 
  else if(is.na(df$first_surgery_date[patient_num]) && !is.na(df$first_vitals_contact_date[patient_num]))
  {
    time_test2 <- difftime(as.Date("11/01/2018","%m/%d/%Y"), df$first_vitals_contact_date[patient_num], units = "days")
    if(time_test2 > 180)
    {
     clean_data <- rbind(clean_data, df[patient_num,])
    } else {
      newpatient_exclude_data <- rbind(newpatient_exclude_data, df[patient_num,])
    }
  } else
  {
    no_vital_data_exclude_data <- rbind(no_vital_data_exclude_data, df[patient_num,])
  }
}



```

### After Exlcusions

We need to decide if we want the exclusion to be 1 year or 6 months

### Imputing Missing Data

```{r impute}


## systolic_sd 30 NA

#clean_data$systolic_sd[is.na(clean_data$systolic_sd)] <- mean(clean_data$systolic_sd, na.rm = TRUE)

## diastolic_sd 30 NA

#clean_data$diastolic_sd[is.na(clean_data$diastolic_sd)] <- mean(clean_data$diastolic_sd, na.rm = TRUE)

## BMI mean 4 NA

#clean_data$BMI_mean[is.na(clean_data$BMI_mean)] <- median(clean_data$BMI_mean, na.rm = TRUE)
# attempts at imputing messed up analyses for some reason

## BMI max 3 NA (median)
#clean_data$BMI_max[is.na(clean_data$BMI_max)] <- median(clean_data$BMI_max, na.rm = TRUE)

## BMImin 3 NA (median)
#clean_data$BMI_min[is.na(clean_data$BMI_min)] <- median(clean_data$BMI_min, na.rm = TRUE)

## alcohol use (12 NAs)
## we will not imput given categorical nature, unclear how this will skew the results
## if it is not significant in initial analyses we will simply exclude from final analyses 

## smoking status (1 NA)
```

## Table One

Here is the descriptive statistics, stratified by history of glaucoma surgery.  Rows from this can be taken to present a final descriptive table, if so desired.  Descriptive table might not be overly meaningful tho...

```{r tableone}



tone_vars = colnames(clean_data)
tone_vars[12] <- NA
tone_vars[28] <- NA

tone <- tableone::CreateTableOne(vars = tone_vars, strata = c("any_glaucoma_surgey") ,data =  clean_data)

```
```{r Bivariate, warning=FALSE}
bi.final <- data.frame(matrix(nrow = 0, ncol = 3))
for(i in 3:ncol(clean_data))
{
if(i == 11 || i == 12 || i == 22 || i == 23 || i == 24 || i == 25 || i == 26 ||i == 28 || i == 135 || i == 130 || i == 123 || i == 109 || i == 104 || i == 92 || i == 84 ||  i == 78 || i == 54 || i == 53){}
  else{
iv <- colnames(clean_data)[i] 
bi.model <- glm (any_glaucoma_surgey ~ get(iv), data = clean_data, family = binomial(link="logit"))
#summary(age)
bi.results <- exp(cbind(OR = coef(bi.model), confint(bi.model)))
rownames(bi.results)[2] <- colnames(clean_data)[i]
bi.final <- rbind(bi.final, bi.results)
}
}



bi.signif <- bi.final[which(bi.final$`2.5 %` > 1 | bi.final$`97.5 %`<1),]
```


## Creating the five groups for cross-validation

```{r fivegroups}

values <- rep(1:5, length.out=391)
random <- sample(values)
clean_data$cv_group <- random

```

## Defining Our Five Groups

```{r define groups}

train.one <- clean_data[which(clean_data$cv_group!= 1),]
test.one <- clean_data[which(clean_data$cv_group== 1),]

train.two <- clean_data[which(clean_data$cv_group!= 2),]
test.two <- clean_data[which(clean_data$cv_group== 2),]

train.three <- clean_data[which(clean_data$cv_group!= 3),]
test.three <- clean_data[which(clean_data$cv_group== 3),]

train.four <- clean_data[which(clean_data$cv_group!= 4),]
test.four <- clean_data[which(clean_data$cv_group== 4),]

train.five <- clean_data[which(clean_data$cv_group!= 5),]
test.five <- clean_data[which(clean_data$cv_group== 5),]

```

## Running Cross Val

### Test 1

```{r test 1, include=FALSE}

model.null.one = glm(any_glaucoma_surgey ~ 1, 
                 data=train.one,
                 family = binomial(link="logit")
                 )

model.full.one = glm(any_glaucoma_surgey ~ Age + Gender +systolic_max + systolic_min + systolic_mean  + diastolic_max + diastolic_min + diastolic_mean +pulse_min + pulse_max + pulse_mean  +ever_hospitalized + days_hospitalized + CHF + PVD + Stroke + Dementia + Pulmonary + LiverMild + DM + DMcx  + Renal + Cancer + Mets + med_class.Analgesics_._non.opioids + med_class.Analgesics_._opioids  +  med_class.Anti.rheumatic +  med_class.Antianxiety_agents  + med_class.Antiasthmatic + med_class.Anticoagulants+med_class.Anticonvulsant+med_class.Antidepressants+med_class.Antidiabetic+med_class.Antiemetics+med_class.Antihyperlipidemic+med_class.Antihypertensive+med_class.Beta_blockers+med_class.Calcium_blockers+med_class.Corticosteroids+med_class.Cough.Cold+med_class.Decongestants+med_class.Dermatological+med_class.Diuretics+med_class.Laxatives+med_class.Macrolide_antibiotics+med_class.Misc._antiinfectives+med_class.Ophthalmic+med_class.Ulcer_drugs, 
                 data=train.one,
                 family = binomial(link="logit")
                 )

step.results.one <- step(model.null.one,
     scope = list(upper=model.full.one),
             direction="both",
             test="Chisq",
             data=clean_data)
```

```{r final model 1}

final.model.one <- eval(step.results.one$call)

pred <- predict.glm(final.model.one, test.one)
test.one$probs <- exp(pred)/(1+exp(pred))
library(pROC)
g.one <- roc(any_glaucoma_surgey ~ probs, data = test.one)
plot(g.one)

```

### Test 2

```{r test 2, include=FALSE}

model.null.two = glm(any_glaucoma_surgey ~ 1, 
                 data=train.two,
                 family = binomial(link="logit")
                 )

model.full.two = glm(any_glaucoma_surgey ~ Age + Gender +systolic_max + systolic_min + systolic_mean  + diastolic_max + diastolic_min + diastolic_mean  +pulse_min + pulse_max + pulse_mean  +ever_hospitalized + days_hospitalized + CHF + PVD + Stroke + Dementia + Pulmonary + LiverMild + DM + DMcx  + Renal + Cancer + Mets + med_class.Analgesics_._non.opioids + med_class.Analgesics_._opioids  +  med_class.Anti.rheumatic +  med_class.Antianxiety_agents  + med_class.Antiasthmatic + med_class.Anticoagulants+med_class.Anticonvulsant+med_class.Antidepressants+med_class.Antidiabetic+med_class.Antiemetics+med_class.Antihyperlipidemic+med_class.Antihypertensive+med_class.Beta_blockers+med_class.Calcium_blockers+med_class.Corticosteroids+med_class.Cough.Cold+med_class.Decongestants+med_class.Dermatological+med_class.Diuretics+med_class.Laxatives+med_class.Macrolide_antibiotics+med_class.Misc._antiinfectives+med_class.Ophthalmic+med_class.Ulcer_drugs, 
                 data=train.two,
                 family = binomial(link="logit")
                 )

step.results.two <- step(model.null.two,
     scope = list(upper=model.full.two),
             direction="both",
             test="Chisq",
             data=clean_data)
```

```{r final model 2}

final.model.two <- eval(step.results.two$call)

pred <- predict(final.model.two, test.two)
test.two$probs <- exp(pred)/(1+exp(pred))
library(pROC)
g.two <- roc(any_glaucoma_surgey ~ probs, data = test.two)
plot(g.two,main="ROC Curve for Logistic Regression",col=2,lwd=2, legacy.axes = TRUE, xlab = "False positive rate", ylab = "True positive rate")



lr.two.pr <- predict(final.model.two, test.two, type="response")
lr.two.pred <- prediction(lr.two.pr,test.two$any_glaucoma_surgey)
lr.two.perf <- performance(lr.two.pred,"tpr","fpr")

plot(lr.two.perf,main="ROC Curve for Logistic Regression",col=2,lwd=2)
abline(a=0,b=1,lwd=2,lty=2,col="gray")


```

```{r get sensitivity and specificity}
opt.cut = function(perf, pred){
    cut.ind = mapply(FUN=function(x, y, p){
        d = (x - 0)^2 + (y-1)^2
        ind = which(d == min(d))
        c(sensitivity = y[[ind]], specificity = 1-x[[ind]], 
            cutoff = p[[ind]])
    }, perf@x.values, perf@y.values, pred@cutoffs)
}
print(opt.cut(lr.two.perf, lr.two.pred))


acc.perf = performance(lr.two.pred, measure = "acc")
plot(acc.perf)

ind = which.max( slot(acc.perf, "y.values")[[1]] )
acc = slot(acc.perf, "y.values")[[1]][ind]
cutoff = slot(acc.perf, "x.values")[[1]][ind]
print(c(accuracy= acc, cutoff = cutoff))

```

### Test 3

```{r test 3, include=FALSE}

model.null.three = glm(any_glaucoma_surgey ~ 1, 
                 data=train.three,
                 family = binomial(link="logit")
                 )

model.full.three = glm(any_glaucoma_surgey ~ Age + Gender +systolic_max + systolic_min + systolic_mean +  diastolic_max + diastolic_min + diastolic_mean +pulse_min + pulse_max + pulse_mean  +ever_hospitalized + days_hospitalized + CHF + PVD + Stroke + Dementia + Pulmonary + LiverMild + DM + DMcx  + Renal + Cancer + Mets + med_class.Analgesics_._non.opioids + med_class.Analgesics_._opioids  +  med_class.Anti.rheumatic +  med_class.Antianxiety_agents  + med_class.Antiasthmatic + med_class.Anticoagulants+med_class.Anticonvulsant+med_class.Antidepressants+med_class.Antidiabetic+med_class.Antiemetics+med_class.Antihyperlipidemic+med_class.Antihypertensive+med_class.Beta_blockers+med_class.Calcium_blockers+med_class.Corticosteroids+med_class.Cough.Cold+med_class.Decongestants+med_class.Dermatological+med_class.Diuretics+med_class.Laxatives+med_class.Macrolide_antibiotics+med_class.Misc._antiinfectives+med_class.Ophthalmic+med_class.Ulcer_drugs, 
                 data=train.three,
                 family = binomial(link="logit")
                 )

step.results.three <- step(model.null.three,
     scope = list(upper=model.full.three),
             direction="both",
             test="Chisq",
             data=clean_data)
```

```{r final model 3, include=FALSE}

final.model.three <- eval(step.results.three$call)

pred <- predict.glm(final.model.three, test.three)
test.three$probs <- exp(pred)/(1+exp(pred))
library(pROC)
g.three <- roc(any_glaucoma_surgey ~ probs, data = test.three)
plot(g.three)

```

### Test 4

```{r test 4, include=FALSE}

model.null.four = glm(any_glaucoma_surgey ~ 1, 
                 data=train.four,
                 family = binomial(link="logit")
                 )

model.full.four = glm(any_glaucoma_surgey ~ Age + Gender +systolic_max + systolic_min + systolic_mean +  diastolic_max + diastolic_min + diastolic_mean +pulse_min + pulse_max + pulse_mean  +ever_hospitalized + days_hospitalized + CHF + PVD + Stroke + Dementia + Pulmonary + LiverMild + DM + DMcx  + Renal + Cancer + Mets + med_class.Analgesics_._non.opioids + med_class.Analgesics_._opioids  +  med_class.Anti.rheumatic +  med_class.Antianxiety_agents  + med_class.Antiasthmatic + med_class.Anticoagulants+med_class.Anticonvulsant+med_class.Antidepressants+med_class.Antidiabetic+med_class.Antiemetics+med_class.Antihyperlipidemic+med_class.Antihypertensive+med_class.Beta_blockers+med_class.Calcium_blockers+med_class.Corticosteroids+med_class.Cough.Cold+med_class.Decongestants+med_class.Dermatological+med_class.Diuretics+med_class.Laxatives+med_class.Macrolide_antibiotics+med_class.Misc._antiinfectives+med_class.Ophthalmic+med_class.Ulcer_drugs, 
                 data=train.four,
                 family = binomial(link="logit")
                 )

step.results.four <- step(model.null.four,
     scope = list(upper=model.full.four),
             direction="both",
             test="Chisq",
             data=clean_data)
```

```{r final model 4}

final.model.four <- eval(step.results.four$call)

pred <- predict.glm(final.model.four, test.four)
test.four$probs <- exp(pred)/(1+exp(pred))
library(pROC)
g.four <- roc(any_glaucoma_surgey ~ probs, data = test.four)
plot(g.four)

```

### Test 5

```{r test 5, include=FALSE}

model.null.five = glm(any_glaucoma_surgey ~ 1, 
                 data=train.five,
                 family = binomial(link="logit")
                 )

model.full.five = glm(any_glaucoma_surgey ~ Age + Gender +systolic_max + systolic_min + systolic_mean + diastolic_max + diastolic_min + diastolic_mean +pulse_min + pulse_max + pulse_mean  +ever_hospitalized + days_hospitalized + CHF + PVD + Stroke + Dementia + Pulmonary + LiverMild + DM + DMcx  + Renal + Cancer + Mets + med_class.Analgesics_._non.opioids + med_class.Analgesics_._opioids  +  med_class.Anti.rheumatic +  med_class.Antianxiety_agents  + med_class.Antiasthmatic + med_class.Anticoagulants+med_class.Anticonvulsant+med_class.Antidepressants+med_class.Antidiabetic+med_class.Antiemetics+med_class.Antihyperlipidemic+med_class.Antihypertensive+med_class.Beta_blockers+med_class.Calcium_blockers+med_class.Corticosteroids+med_class.Cough.Cold+med_class.Decongestants+med_class.Dermatological+med_class.Diuretics+med_class.Laxatives+med_class.Macrolide_antibiotics+med_class.Misc._antiinfectives+med_class.Ophthalmic+med_class.Ulcer_drugs, 
                 data=train.five,
                 family = binomial(link="logit")
                 )

step.results.five <- step(model.null.five,
     scope = list(upper=model.full.five),
             direction="both",
             test="Chisq",
             data=clean_data)
```

```{r final model 5}

final.model.five <- eval(step.results.five$call)

pred <- predict.glm(final.model.five, test.five)
test.five$probs <- exp(pred)/(1+exp(pred))
library(pROC)
g.five <- roc(any_glaucoma_surgey ~ probs, data = test.five)
plot(g.five)

```

### COMAPRE ROC

```{r roc comapre}

print(g.one$auc)
print(g.two$auc)
print(g.three$auc)
print(g.four$auc)
print(g.five$auc)

```

## Results of Best Model

```{r looking at the best}

results <- round(exp(cbind(OR = coef(final.model.five), confint(final.model.five))),2)
results

```

## Evaluating This Model

### Discrimination (C-Statistic aka AUC)

```{r AUC}

g.five$auc
plot(g.five)

```

### Caibration (Hoslem-Lemeshow)

```{r calibration}

library(generalhoslem)
logitgof(test.five$any_glaucoma_surgey, test.five$probs, g = 5)
library(gbm)
calibrate.plot(test.five$any_glaucoma_surgey, test.five$probs)
```


```{r Saving Docs}

final_test_set <- test.five
final_training_set <- train.five
final_regression_equation <- "glm(formula = any_glaucoma_surgey ~ med_class.Ophthalmic + med_class.Analgesics_._non.opioids + systolic_min + days_hospitalized + med_class.Antihyperlipidemic + systolic_mean + med_class.Macrolide_antibiotics + med_class.Calcium_blockers + med_class.Cough.Cold + med_class.Decongestants + med_class.Anticoagulants + Mets, family = binomial(link = 'logit'), data = train.five)"
final_ORs <- results
final_model_coefficients <- final.model.five$coefficients

write.csv(final_test_set, "Final_Test_Set_Dec8.csv")
write.csv(final_training_set, "Final_Training_Set_Dec8.csv")
write.file(final_regression_equation, "final_regression_equation.txt")
write.csv(final_ORs, "final_logistic_regression_results.csv")
write.csv(final_model_coefficients, "final_model_coefficients.csv")
```

## Now We Are GOing to Do Random Forests

It is a little different, we don't do crossval.  Random forest algorithm kind of automatically does this for us.  

```{r libraries}
library(randomForest)
```

## Running random Forest 


